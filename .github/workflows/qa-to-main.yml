name: QA to Main - Auto PR and Deploy

on:
  push:
    branches:
      - qa

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    name: Create Pull Request to Main
    
    steps:
      - name: Checkout QA branch
        uses: actions/checkout@v4
        with:
          ref: qa
          fetch-depth: 0

      - name: Get commit info
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commitMsg = `${{ steps.commit_info.outputs.commit_msg }}`;
            const commitSha = `${{ steps.commit_info.outputs.commit_sha }}`;
            
            const prTitle = `[AUTO] QA â†’ Main: ${commitMsg.split('\n')[0]} (${commitSha})`;
            const prBody = `## Automated Pull Request from QA to Main
            
            **Commit:** ${commitSha}
            **Branch:** qa â†’ main
            **Time:** ${new Date().toISOString()}
            
            ### Changes
            \`\`\`
            ${commitMsg}
            \`\`\`
            
            ### Checklist
            - [ ] Code review completed
            - [ ] All tests passing
            - [ ] Database migrations verified
            - [ ] Ready for production deployment
            
            @JuanGuevara90 - Please review and merge when ready.`;

            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: 'qa',
              base: 'main'
            });

            if (existingPRs.length === 0) {
              const { data: newPR } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: 'qa',
                base: 'main',
                body: prBody,
                reviewers: ['JuanGuevara90']
              });
              
              console.log(`âœ… Pull Request created: #${newPR.number}`);
              console.log(`   Title: ${newPR.title}`);
              console.log(`   URL: ${newPR.html_url}`);
              
              core.setOutput('pr_number', newPR.number);
              core.setOutput('pr_url', newPR.html_url);
            } else {
              console.log(`â„¹ï¸  Pull Request already exists: #${existingPRs[0].number}`);
              core.setOutput('pr_number', existingPRs[0].number);
              core.setOutput('pr_url', existingPRs[0].html_url);
            }

      - name: Post PR notification
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            console.log('âœ… Automated workflow completed successfully');
            console.log('ðŸ“‹ PR created for review by: JuanGuevara90');
            console.log('ðŸš€ Once merged to main, production deployment will trigger');

  # This job triggers after PR is merged to main
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: create-pr
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Init (Production)
        working-directory: ./infrastructure/prod
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=us-east-1"

      - name: Terraform Plan (Production)
        working-directory: ./infrastructure/prod
        run: terraform plan -out=tfplan

      - name: Terraform Apply (Production)
        working-directory: ./infrastructure/prod
        run: terraform apply -auto-approve tfplan

      - name: Get ALB DNS
        working-directory: ./infrastructure/prod
        id: alb
        run: |
          ALB_DNS=$(terraform output -raw alb_dns_name)
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT

      - name: Post deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ðŸš€ Production deployment completed successfully');
            console.log('ðŸ“Š ALB DNS: ${{ steps.alb.outputs.alb_dns }}');

  slack-notification:
    runs-on: ubuntu-latest
    name: Slack Notification
    if: always()
    needs: [create-pr]
    
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.24.0
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        with:
          payload: |
            {
              "text": "ðŸ”„ UCEHub CI/CD Pipeline",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*QA to Main Auto-PR*\nBranch: `qa`\nStatus: âœ… Success\nPR created for review"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
