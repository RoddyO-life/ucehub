#!/bin/bash
set -e
exec > >(tee /var/log/user-data.log) 2>&1

echo "=== UCEHub v2 - Interactive Forms ==="
yum update -y
yum install -y nodejs npm nginx

# Backend (same as before)
mkdir -p /opt/backend && cd /opt/backend
cat > package.json << 'EOF'
{"name":"ucehub","version":"2.0.0","dependencies":{"express":"^4.18.2","body-parser":"^1.20.2","cors":"^2.8.5","@aws-sdk/client-dynamodb":"^3.490.0","@aws-sdk/lib-dynamodb":"^3.490.0","uuid":"^9.0.1"}}
EOF

cat > index.js << 'EOF'
const express=require('express'),bodyParser=require('body-parser'),cors=require('cors'),os=require('os'),https=require('https'),{DynamoDBClient}=require('@aws-sdk/client-dynamodb'),{DynamoDBDocumentClient,PutCommand,QueryCommand}=require('@aws-sdk/lib-dynamodb'),{v4:uuidv4}=require('uuid'),app=express();app.use(cors({origin:'*'}));app.use(bodyParser.json());const client=new DynamoDBClient({region:process.env.AWS_REGION||'us-east-1'}),ddb=DynamoDBDocumentClient.from(client),CAFETERIA_TABLE=process.env.CAFETERIA_TABLE||'',SUPPORT_TABLE=process.env.SUPPORT_TICKETS_TABLE||'',TEAMS_WEBHOOK=process.env.TEAMS_WEBHOOK_URL||'',getIP=()=>{const ifaces=os.networkInterfaces();for(let iface of Object.values(ifaces))for(let addr of iface)if(addr.family==='IPv4'&&!addr.internal)return addr.address;return'unknown'},instanceIP=getIP();const sendTeams=(msg)=>{if(!TEAMS_WEBHOOK)return;const data=JSON.stringify(msg);const url=new URL(TEAMS_WEBHOOK);const opts={hostname:url.hostname,path:url.pathname+url.search,method:'POST',headers:{'Content-Type':'application/json','Content-Length':data.length}};const req=https.request(opts,()=>{});req.on('error',()=>{});req.write(data);req.end()};app.get('/health',(req,res)=>res.json({status:'healthy',service:'ucehub',instance:instanceIP,uptime:process.uptime(),tables:{cafeteria:CAFETERIA_TABLE,support:SUPPORT_TABLE}}));app.get('/',(req,res)=>res.json({message:'UCEHub API v2',instance:instanceIP}));app.post('/auth/login',(req,res)=>res.json({success:true,token:'jwt-'+uuidv4(),user:{id:uuidv4(),username:req.body.username||'test',email:(req.body.username||'test')+'@uce.edu.ec',role:'student'},instance:instanceIP}));app.post('/certificados/solicitar',(req,res)=>{const cert={certificateId:'CERT-'+uuidv4(),userEmail:req.body.userEmail||'student@uce.edu.ec',tipo:req.body.tipo||'Matricula',motivo:req.body.motivo||'',estado:'Pendiente de Aprobaci√≥n',timestamp:Date.now()};sendTeams({'@type':'MessageCard','@context':'http://schema.org/extensions',themeColor:'0076D7',summary:'Nueva Solicitud de Certificado',sections:[{activityTitle:'üìú Nueva Solicitud de Certificado - UCEHub',activitySubtitle:'Requiere aprobaci√≥n',facts:[{name:'ID:',value:cert.certificateId},{name:'Email:',value:cert.userEmail},{name:'Tipo:',value:cert.tipo},{name:'Motivo:',value:cert.motivo||'No especificado'},{name:'Estado:',value:cert.estado},{name:'Instancia:',value:instanceIP}],markdown:true}],potentialAction:[{'@type':'OpenUri',name:'Ver Detalles',targets:[{os:'default',uri:'http://ucehub-alb-qa-933851656.us-east-1.elb.amazonaws.com'}]},{'@type':'HttpPOST',name:'‚úÖ Aprobar',target:'http://ucehub-alb-qa-933851656.us-east-1.elb.amazonaws.com/api/certificados/aprobar'},{('@type':'HttpPOST',name:'‚ùå Rechazar',target:'http://ucehub-alb-qa-933851656.us-east-1.elb.amazonaws.com/api/certificados/rechazar'}]});res.json({success:true,message:'Certificado solicitado. Notificaci√≥n enviada a Teams.',data:cert,instance:instanceIP})});app.post('/biblioteca/reservar',(req,res)=>res.json({success:true,message:'Reserva confirmada',data:{reservationId:'RES-'+uuidv4(),userEmail:req.body.userEmail||'student@uce.edu.ec',recurso:req.body.recurso||'Sala de estudio',fecha:req.body.fecha||new Date().toISOString().split('T')[0],hora:req.body.hora||'10:00',estado:'Confirmado',timestamp:Date.now()},instance:instanceIP}));app.post('/becas/solicitar',(req,res)=>res.json({success:true,message:'Beca solicitada',data:{applicationId:'BECA-'+uuidv4(),userEmail:req.body.userEmail||'student@uce.edu.ec',tipoBeca:req.body.tipoBeca||'Socioecon√≥mica',ingresos:req.body.ingresos||'',promedio:req.body.promedio||'',estado:'En revisi√≥n',timestamp:Date.now()},instance:instanceIP}));app.post('/soporte/ticket',async(req,res)=>{try{const ticket={ticketId:'TICKET-'+uuidv4(),userEmail:req.body.userEmail||'student@uce.edu.ec',asunto:req.body.asunto||'Consulta',descripcion:req.body.descripcion||'',prioridad:req.body.prioridad||'Media',status:'Abierto',createdAt:Date.now(),updatedAt:Date.now()};await ddb.send(new PutCommand({TableName:SUPPORT_TABLE,Item:ticket}));res.json({success:true,message:'Ticket creado en DynamoDB',data:ticket,instance:instanceIP})}catch(e){res.status(500).json({success:false,message:e.message})}});app.get('/soporte/tickets',async(req,res)=>{try{const result=await ddb.send(new QueryCommand({TableName:SUPPORT_TABLE,IndexName:'UserEmailIndex',KeyConditionExpression:'userEmail = :email',ExpressionAttributeValues:{':email':req.query.email||'student@uce.edu.ec'},Limit:10}));res.json({success:true,tickets:result.Items||[],count:result.Count,instance:instanceIP})}catch(e){res.status(500).json({success:false,message:e.message})}});app.post('/cafeteria/order',async(req,res)=>{try{const order={orderId:'ORDER-'+uuidv4(),userEmail:req.body.userEmail||'student@uce.edu.ec',items:req.body.items||[],total:req.body.total||0,notas:req.body.notas||'',status:'Pendiente',timestamp:Date.now(),expirationTime:Math.floor(Date.now()/1000)+(30*24*60*60)};await ddb.send(new PutCommand({TableName:CAFETERIA_TABLE,Item:order}));res.json({success:true,message:'Pedido guardado en DynamoDB',data:order,instance:instanceIP})}catch(e){res.status(500).json({success:false,message:e.message})}});app.get('/cafeteria/orders',async(req,res)=>{try{const result=await ddb.send(new QueryCommand({TableName:CAFETERIA_TABLE,IndexName:'UserEmailIndex',KeyConditionExpression:'userEmail = :email',ExpressionAttributeValues:{':email':req.query.email||'student@uce.edu.ec'},Limit:10}));res.json({success:true,orders:result.Items||[],count:result.Count,instance:instanceIP})}catch(e){res.status(500).json({success:false,message:e.message})}});app.listen(3001,'127.0.0.1',()=>console.log('UCEHub Backend v2 on port 3001'));
EOF

npm install

cat > /etc/systemd/system/ucehub-backend.service << EOF
[Unit]
Description=UCEHub Backend
After=network.target
[Service]
Type=simple
User=root
WorkingDirectory=/opt/backend
Environment="AWS_REGION=${region}"
Environment="CAFETERIA_TABLE=${cafeteria_table}"
Environment="SUPPORT_TICKETS_TABLE=${support_table}"
Environment="ABSENCE_JUSTIFICATIONS_TABLE=${absence_table}"
Environment="TEAMS_WEBHOOK_URL=${teams_webhook_url}"
ExecStart=/usr/bin/node /opt/backend/index.js
Restart=always
RestartSec=10
[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ucehub-backend
systemctl start ucehub-backend

# Frontend ultra-minificado
mkdir -p /opt/frontend/dist && cd /opt/frontend/dist
cat > index.html << 'EOF'
<!DOCTYPE html><html><head><meta charset="UTF-8"><title>UCEHub</title><style>*{margin:0;padding:0}body{font-family:Arial;background:#667eea;min-height:100vh;display:flex;flex-direction:column}.h{background:#fff;padding:1rem;box-shadow:0 2px 10px rgba(0,0,0,.1)}.h h1{color:#667eea}.c{flex:1;max-width:1200px;margin:2rem auto;padding:0 2rem;width:100%}.w{background:#fff;border-radius:15px;padding:2rem;text-align:center;margin-bottom:2rem}.g{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}.s{background:#fff;border-radius:10px;padding:1.5rem;box-shadow:0 5px 15px rgba(0,0,0,.1);cursor:pointer;text-align:center}.s:hover{transform:translateY(-5px)}.s h3{color:#667eea}.m{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}.mc{background:#fff;margin:5% auto;padding:2rem;border-radius:10px;max-width:500px;width:90%}.x{float:right;font-size:28px;cursor:pointer}input,select,textarea{width:100%;padding:.8rem;margin:.5rem 0;border:1px solid #ddd;border-radius:5px}button{background:#667eea;color:#fff;padding:.8rem 2rem;border:none;border-radius:5px;cursor:pointer;margin-top:1rem}</style></head><body><div class="h"><h1>üéì UCEHub</h1></div><div class="c"><div class="w"><h2>Portal UCE</h2></div><div class="g"><div class="s" onclick="o('a')"><div style="font-size:2rem">üîê</div><h3>Auth</h3></div><div class="s" onclick="o('c')"><div style="font-size:2rem">üìú</div><h3>Certificados</h3></div><div class="s" onclick="o('b')"><div style="font-size:2rem">üìö</div><h3>Biblioteca</h3></div><div class="s" onclick="o('k')"><div style="font-size:2rem">üí∞</div><h3>Becas</h3></div><div class="s" onclick="o('s')"><div style="font-size:2rem">üé´</div><h3>Soporte</h3></div><div class="s" onclick="o('f')"><div style="font-size:2rem">üçΩÔ∏è</div><h3>Cafeter√≠a</h3></div></div></div><div id="m" class="m"><div class="mc"><span class="x" onclick="cl()">&times;</span><div id="mb"></div></div></div><script>const e='student@uce.edu.ec',p='/api/',h={'Content-Type':'application/json'};function o(t){const f={a:'<h2>Auth</h2><input id="u" placeholder="User"><input id="p" type="password" placeholder="Pass"><button onclick="sa()">Login</button>',c:'<h2>Certificado</h2><input id="e" value="'+e+'"><select id="t"><option>Matr√≠cula</option><option>Notas</option><option>Conducta</option></select><textarea id="m" placeholder="Motivo"></textarea><button onclick="sc()">Solicitar</button>',b:'<h2>Biblioteca</h2><input id="e" value="'+e+'"><select id="r"><option>Sala #1</option><option>Sala #2</option></select><input id="f" type="date"><input id="h" type="time" value="10:00"><button onclick="sb()">Reservar</button>',k:'<h2>Beca</h2><input id="e" value="'+e+'"><select id="t"><option>Socioecon√≥mica</option><option>Excelencia</option></select><input id="i" placeholder="Ingresos"><input id="p" placeholder="Promedio" type="number"><button onclick="sk()">Solicitar</button>',s:'<h2>Soporte</h2><input id="e" value="'+e+'"><input id="a" placeholder="Asunto"><textarea id="d"></textarea><select id="p"><option>Baja</option><option>Media</option><option>Alta</option></select><button onclick="ss()">Crear</button>',f:'<h2>Cafeter√≠a</h2><input id="e" value="'+e+'"><select id="i"><option>Men√∫ ($3.50)</option><option>Ejecutivo ($4.00)</option></select><input id="n" placeholder="Notas"><button onclick="sf()">Pedir</button>'};document.getElementById('mb').innerHTML=f[t];document.getElementById('m').style.display='block'}function cl(){document.getElementById('m').style.display='none'}async function sa(){const u=document.getElementById('u').value;try{const r=await fetch(p+'auth/login',{method:'POST',headers:h,body:JSON.stringify({username:u,password:document.getElementById('p').value})});const d=await r.json();alert('OK '+d.user.username);cl()}catch(x){alert('ERR')}}async function sc(){try{const r=await fetch(p+'certificados/solicitar',{method:'POST',headers:h,body:JSON.stringify({userEmail:document.getElementById('e').value,tipo:document.getElementById('t').value,motivo:document.getElementById('m').value})});const d=await r.json();alert('OK ID:'+d.data.certificateId);cl()}catch(x){alert('ERR')}}async function sb(){try{const r=await fetch(p+'biblioteca/reservar',{method:'POST',headers:h,body:JSON.stringify({userEmail:document.getElementById('e').value,recurso:document.getElementById('r').value,fecha:document.getElementById('f').value,hora:document.getElementById('h').value})});const d=await r.json();alert('OK ID:'+d.data.reservationId);cl()}catch(x){alert('ERR')}}async function sk(){try{const r=await fetch(p+'becas/solicitar',{method:'POST',headers:h,body:JSON.stringify({userEmail:document.getElementById('e').value,tipoBeca:document.getElementById('t').value,ingresos:document.getElementById('i').value,promedio:document.getElementById('p').value})});const d=await r.json();alert('OK ID:'+d.data.applicationId);cl()}catch(x){alert('ERR')}}async function ss(){try{const r=await fetch(p+'soporte/ticket',{method:'POST',headers:h,body:JSON.stringify({userEmail:document.getElementById('e').value,asunto:document.getElementById('a').value,descripcion:document.getElementById('d').value,prioridad:document.getElementById('p').value})});const d=await r.json();alert('OK ID:'+d.data.ticketId);cl()}catch(x){alert('ERR')}}async function sf(){const i=document.getElementById('i').value;try{const r=await fetch(p+'cafeteria/order',{method:'POST',headers:h,body:JSON.stringify({userEmail:document.getElementById('e').value,items:[{name:i,quantity:1,price:parseFloat(i.match(/\$(\d+\.\d+)/)[1])}],total:parseFloat(i.match(/\$(\d+\.\d+)/)[1]),notas:document.getElementById('n').value})});const d=await r.json();alert('OK ID:'+d.data.orderId);cl()}catch(x){alert('ERR')}}</script></body></html>
EOF

# Nginx
cat > /etc/nginx/nginx.conf << 'EOF'
user nginx;worker_processes auto;error_log /var/log/nginx/error.log;pid /run/nginx.pid;events{worker_connections 1024;}http{log_format main '$remote_addr - $remote_user [$time_local] "$request" $status';access_log /var/log/nginx/access.log main;sendfile on;tcp_nopush on;keepalive_timeout 65;types_hash_max_size 4096;include /etc/nginx/mime.types;default_type application/octet-stream;server{listen 80;server_name _;root /opt/frontend/dist;index index.html;location /health{proxy_pass http://127.0.0.1:3001/health;}location /api/{rewrite ^/api/(.*) /$1 break;proxy_pass http://127.0.0.1:3001;}location /{try_files $uri /index.html;}}}
EOF

systemctl restart nginx
systemctl enable nginx

echo "=== UCEHub v2 Ready ==="
systemctl status ucehub-backend --no-pager | head -5
systemctl status nginx --no-pager | head -3
